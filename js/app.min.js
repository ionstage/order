!function e(t,r,n){function i(a,s){if(!r[a]){if(!t[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(o)return o(a,!0);var c=new Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",c}var p=r[a]={exports:{}};t[a][0].call(p.exports,function(e){var r=t[a][1][e];return i(r?r:e)},p,p.exports,e,t,r,n)}return r[a].exports}for(var o="function"==typeof require&&require,a=0;a<n.length;a++)i(n[a]);return i}({1:[function(e,t,r){!function(r){"use strict";var n=r.helper||e("../helper.js"),i=r.dom||e("../dom.js"),o=r.Component||e("./component.js"),a=function(){this.data=[],this.index=0};a.prototype.back=function(){return this.index=Math.max(this.index-1,0),this.current()},a.prototype.forward=function(){return this.index=Math.min(this.index+1,this.data.length),this.current()},a.prototype.push=function(e){this.data.push(e),this.index=this.data.length},a.prototype.current=function(){return this.data[this.index]||""};var s=n.inherits(function(e){s.super_.call(this);var t=e.element;this.element=this.prop(t),this.executor=e.executor,this.inputHistory=new a,i.on(t,"keydown",s.prototype.onkeydown.bind(this))},o);s.prototype.text=function(e){return i.value(this.element(),e)},s.prototype.disabled=function(e){i.disabled(this.element(),e)},s.prototype.focus=function(){i.focus(this.element())},s.prototype.onkeydown=function(e){var t=s.keyMap[e.which];t&&this["on"+t](e)},s.prototype.onenter=function(){var e=this.text();e&&Promise.resolve().then(function(){return this.disabled(!0),this.executor(e)}.bind(this)).then(function(){this.inputHistory.push(e),this.text(""),this.disabled(!1),this.focus()}.bind(this))["catch"](function(e){console.error(e),this.disabled(!1),this.focus()}.bind(this))},s.prototype.onup=function(e){e.preventDefault(),this.text(this.inputHistory.back())},s.prototype.ondown=function(e){e.preventDefault(),this.text(this.inputHistory.forward())},s.keyMap={13:"enter",38:"up",40:"down"},"undefined"!=typeof t&&t.exports?t.exports=s:r.CommandInput=s}(this.app||(this.app={}))},{"../dom.js":5,"../helper.js":6,"./component.js":2}],2:[function(e,t,r){!function(r){"use strict";var n=r.helper||e("../helper.js"),i=r.dom||e("../dom.js"),o=function(){this.relations=this.prop([])};o.prototype.prop=function(e,t,r){"function"!=typeof r&&(r=n.identity);var i=r(e,t);return function(e){return"undefined"==typeof e?i:void(e!==i&&(i=r(e,i),this.markDirty()))}},o.prototype.redraw=function(){},o.prototype.markDirty=function(){var e=[],t=null,r=function(t){for(var n=t,i=e.length;i>n;n++){var o=e[n];o.relations().forEach(function(e){e.update(o)})}e.length>i&&r(i)},n=function(){r(0),e.forEach(function(e){e.redraw()}),e=[],t=null};return function(){i.unsupported()||(-1===e.indexOf(this)&&e.push(this),null===t&&(t=i.animate(n)))}}(),"undefined"!=typeof t&&t.exports?t.exports=o:r.Component=o}(this.app||(this.app={}))},{"../dom.js":5,"../helper.js":6}],3:[function(e,t,r){!function(r){"use strict";var n=r.helper||e("../helper.js"),i=r.Component||e("./component.js"),o=r.VariableComponent||e("./variable-component.js"),a=n.inherits(function(e){a.super_.call(this),this.variables=this.prop([]),this.element=this.prop(e.element)},i);a.prototype.loadVariable=function(e,t){return o.load({name:e,moduleName:t,parentElement:this.element()}).then(function(e){return this.variables().push(e),e}.bind(this))},a.prototype.deleteVariable=function(e){for(var t=this.variables(),r=t.length-1;r>=0;r--){var n=t[r];if(n.name()===e)return n.parentElement(null),void t.splice(r,1)}},"undefined"!=typeof t&&t.exports?t.exports=a:r.ContentComponent=a}(this.app||(this.app={}))},{"../helper.js":6,"./component.js":2,"./variable-component.js":4}],4:[function(e,t,r){!function(r){"use strict";var n=r.helper||e("../helper.js"),i=r.dom||e("../dom.js"),o=r.CircuitElement||e("../models/circuit-element.js"),a=r.Component||e("./component.js"),s=n.inherits(function(e){s.super_.call(this),this.name=this.prop(e.name),this.moduleName=this.prop(e.moduleName),this.element=this.prop(null),this.parentElement=this.prop(e.parentElement)},a);s.prototype.circuitElement=function(){var e=i.child(this.element(),1),t=n.dig(i.contentWindow(e),"order","exports");return t||o.empty()},s.prototype.render=function(){var e=i.el("<div>");i.addClass(e,"variable"),i.html(e,['<div class="variable-header">','<div class="variable-name"></div>','<div class="variable-module-name"></div>',"</div>",'<iframe class="variable-content"></iframe>'].join(""));var t=i.child(e,0),r=i.child(t,0);i.text(r,this.name());var n=i.child(t,1);return i.text(n,this.moduleName()),e},s.prototype.redraw=function(){var e=this.element(),t=this.parentElement();!t&&e&&(i.remove(e),this.element(null))},s.prototype.load=function(e){var t=this.render();this.element(t),i.append(this.parentElement(),t);var r=i.child(t,1),n=i.contentWindow(r),o=Date.now().toString();i.name(n,o),i.writeContent(r,e),i.fillContentHeight(r);var a;return Promise.race([new Promise(function(e,t){a=function(r){try{if(r.origin!==i.origin())throw new Error("OrderScript runtime error: Invalid content origin");if(r.data!==o)throw new Error("OrderScript runtime error: Invalid content data");if(!this.circuitElement())throw new Error("OrderScript runtime error: Invalid circuit element");e(this)}catch(n){i.remove(this.element()),this.element(null),t(n)}}.bind(this),i.on(n,"message",a)}.bind(this)),new Promise(function(e,t){setTimeout(t,3e4,new Error("OrderScript runtime error: Load timeout for content"))})]).then(function(e){return i.off(n,"message",a),e})["catch"](function(e){throw i.off(n,"message",a),e})},s.load=function(e){var t=e.name,r=e.moduleName,n=e.parentElement,o=["order_modules/",r.split("/").map(function(e){return encodeURIComponent(e)}).join("/"),".html"].join("");return i.ajax({type:"GET",url:o}).then(function(e){var i=new s({name:t,moduleName:r,parentElement:n});return i.load(e)})},"undefined"!=typeof t&&t.exports?t.exports=s:r.VariableComponent=s}(this.app||(this.app={}))},{"../dom.js":5,"../helper.js":6,"../models/circuit-element.js":7,"./component.js":2}],5:[function(e,t,r){!function(e){"use strict";var r={};r.unsupported=function(){return"undefined"==typeof document},r.el=function(e){return"<"===e.charAt(0)?(e=e.match(/<(.+)>/)[1],document.createElement(e)):document.querySelector(e)},r.append=function(e,t){e.appendChild(t)},r.remove=function(e){e.parentNode.removeChild(e)},r.child=function(e,t){return e.childNodes[t]},r.addClass=function(e,t){e.classList.add(t)},r.name=function(e,t){e.name=t},r.text=function(e,t){e.textContent=t},r.html=function(e,t){e.innerHTML=t},r.value=function(e,t){return"undefined"==typeof t?e.value:void(e.value=t)},r.disabled=function(e,t){e.disabled=t},r.focus=function(e){e.focus()},r.contentWindow=function(e){return e.contentWindow},r.writeContent=function(e,t){var r=e.contentDocument;r.open(),r.write(t),r.close()},r.fillContentHeight=function(e){e.style.height=e.contentDocument.documentElement.scrollHeight+"px"},r.openWindow=function(e,t){return new Promise(function(r,n){var i=window.open();if(i){var o=i.document;o.open(),o.write(t),o.close(),o.title=e,r()}else n()})},r.animate=function(e){return window.requestAnimationFrame(e)},r.on=function(e,t,r){e.addEventListener(t,r)},r.off=function(e,t,r){e.removeEventListener(t,r)},r.ajax=function(e){var t=e.type,r=e.url;return new Promise(function(e,n){var i=new XMLHttpRequest,o=function(){n(new Error("Failed to load resource: "+t+" "+r))};i.onload=function(){i.status>=200&&i.status<400?e(i.responseText):o()},i.onerror=o,i.onabort=o,i.open(t,r,!0),i.send()})},r.origin=function(){return location.protocol+"//"+location.host},"undefined"!=typeof t&&t.exports?t.exports=r:e.dom=r}(this.app||(this.app={}))},{}],6:[function(e,t,r){!function(e){"use strict";var r={};r.inherits=function(e,t){return e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),e},r.identity=function(e){return e},r.List=function(){var e=function(){this.data=[]};return e.prototype.add=function(e){this.contains(e)||this.data.push(e)},e.prototype.remove=function(e){for(var t=this.data,r=t.length-1;r>=0;r--)if(this.equal(t[r],e)){t.splice(r,1);break}},e.prototype.contains=function(e){return this.data.some(function(t){return this.equal(t,e)}.bind(this))},e.prototype.equal=function(e,t){return e===t},e.prototype.toArray=function(){return this.data.slice()},e}(),r.capitalize=function(e){return e.charAt(0).toUpperCase()+e.slice(1)},r.dig=function(){var e=Array.prototype.slice.call(arguments);return e.reduce(function(e,t){return"object"==typeof e?e[t]:null})},r.bindAll=function(e){var t=Object.getPrototypeOf(e);for(var r in t)e[r]=t[r].bind(e)},"undefined"!=typeof t&&t.exports?t.exports=r:e.helper=r}(this.app||(this.app={}))},{}],7:[function(e,t,r){!function(r){"use strict";var n=e("circuit"),i=function(e,t){return e.unwrap=i.unwrap.bind(t),e};i.unwrap=function(e){return e===i.KEY?this:void 0},i.KEY={};var o=function(e){var t=e.name,r=e.arg,a=e.type;("undefined"==typeof a||"prop"!==a&&"event"!==a)&&(a=0===t.indexOf("on")?"event":"prop");var s=n[a](r),u=o.prototype.call.bind(this);this.name=t,this.callee=s,this.wrapper=new i(u,this),this.sources=[],this.targets=[]};o.prototype.call=function(){return this.callee.apply(this,arguments)};var a=function(e){var t={},r=[];e.slice().reverse().forEach(function(e){var n=e.name;n in t||(t[n]=new o(e),r.unshift(n))}),this.memberTable=t,this.names=r};a.prototype.get=function(e){var t=this.memberTable[e];return t?t.wrapper:null},a.prototype.getAll=function(){return this.names.map(function(e){return this.memberTable[e].wrapper}.bind(this))},a.empty=function(){return new a([])},a.bind=function(e,t){var r=e.unwrap(i.KEY),o=t.unwrap(i.KEY);n.bind(r.callee,o.callee),r.targets.push(o),o.sources.push(r)},a.unbind=function(e,t){var r=e.unwrap(i.KEY),o=t.unwrap(i.KEY);n.unbind(r.callee,o.callee);var a=r.targets,s=o.sources;a.splice(a.indexOf(o),1),s.splice(s.indexOf(r),1)},a.unbindAll=function(e){var t=e.unwrap(i.KEY);t.sources.forEach(function(e){a.unbind(e.wrapper,t.wrapper)}),t.targets.forEach(function(e){a.unbind(t.wrapper,e.wrapper)})},"undefined"!=typeof t&&t.exports?t.exports=a:r.CircuitElement=a}(this.app||(this.app={}))},{circuit:void 0}],8:[function(e,t,r){!function(r){"use strict";var n=r.helper||e("../helper.js"),i={};i.Noop=function(){},i.New=function(){if(2!==arguments.length)throw new TypeError("Type error");var e=arguments[0],t=arguments[1];if(-1!==e.indexOf(".")||-1!==t.indexOf("."))throw new TypeError("Type error");if(!/^[a-zA-Z]/.test(e)||!/^[a-zA-Z]/.test(t))throw new TypeError("Type error");this.variableName=e,this.moduleName=t},i.Bind=function(){if(2!==arguments.length)throw new TypeError("Type error");var e=arguments[0].split("."),t=arguments[1].split(".");if(2!==e.length||2!==t.length)throw new TypeError("Type error");this.sourceVariableName=e[0],this.sourceMemberName=e[1],this.targetVariableName=t[0],this.targetMemberName=t[1]},i.Unbind=function(){i.Bind.apply(this,arguments)},i.Send=function(){if(1!==arguments.length&&2!==arguments.length)throw new TypeError("Type error");var e=arguments[0].split(".");if(2!==e.length)throw new TypeError("Type error");this.variableName=e[0],this.memberName=e[1],this.dataText=arguments[1]||""},i.Delete=function(){if(1!==arguments.length)throw new TypeError("Type error");var e=arguments[0];if(-1!==e.indexOf("."))throw new TypeError("Type error");if(!/^[a-zA-Z]/.test(e))throw new TypeError("Type error");this.variableName=e},i.Reset=function(){if(arguments.length)throw new TypeError("Type error")},i.Load=function(){if(0!==arguments.length&&1!==arguments.length)throw new TypeError("Type error");this.filePath=arguments[0]||""},i.Save=function(){if(0!==arguments.length&&1!==arguments.length)throw new TypeError("Type error");this.filePath=arguments[0]||""},i.expandAbbreviation=function(e){var t=e.split("#")[0].trim();if(!t||":"===t.charAt(0))return e;var r=t.match(/^([^:]+):([^:]+)$/);if(r)return":new "+r[1].trim()+" "+r[2].trim();var n=t.split(">>");if(2===n.length){var i=n[0].trim().split("."),o=n[1].trim().split(".");if(2===i.length&&2===o.length)return":bind "+i.join(".")+" "+o.join(".")}if(n=t.split("<<"),2===n.length){var i=n[0].trim().split("."),a=n[1].trim();if(2===i.length)return":send "+i.join(".")+(a?" "+a:"")}return e},i.parseStatement=function(e){var t=e.split("#")[0].trim();if(!t){var r=new i.Noop;return r.name="noop",r}if(":"===t)throw new SyntaxError("OrderScript parse error: Unexpected EOF");if(":"!==t.charAt(0))throw new SyntaxError('OrderScript parse error: Unexpected identifier "'+e+'"');var o=t.slice(1).split(/([^\\]".*?[^\\]"|[^\\]'.*?[^\\]')/).map(function(e,t,r){if(t%2===0)return e.split(/[\s]+/).map(function(e){return e.replace(/\\'/g,"'").replace(/\\"/g,'"')});e=e.trim();var n=e.charAt(0),i=e.slice(-1);return n!==i||"'"!==n&&'"'!==n||(e=e.slice(1,-1)),e}).reduce(function(e,t){return e.concat(t)},[]).filter(function(e){return e}),a=o.shift(),s=a.toLowerCase(),u=i[n.capitalize(s)];if(!u)throw new SyntaxError('OrderScript parse error: Unexpected command "'+a+'"');o.unshift(null);var r;try{r=new(Function.prototype.bind.apply(u,o))}catch(c){throw new SyntaxError('OrderScript parse error: Unexpected identifier "'+e+'"')}return r.name=s,r},"undefined"!=typeof t&&t.exports?t.exports=i:r.command=i}(this.app||(this.app={}))},{"../helper.js":6}],9:[function(e,t,r){!function(r){"use strict";var n=r.helper||e("../helper.js"),i=r.command||e("./command.js"),o=r.CircuitElement||e("./circuit-element.js"),a=function(e){this.name=e.name,this.moduleName=e.moduleName,this.circuitElement=e.circuitElement};a.prototype.fetchMember=function(e){var t=this.circuitElement.get(e);if(!t)throw new Error('OrderScript runtime error: member "'+this.name+"."+e+'" is not defined');return t},a.prototype.members=function(){return this.circuitElement.getAll()};var s=function(){this.table={},this.names=[]};s.prototype.has=function(e){return-1!==this.names.indexOf(e)},s.prototype.fetch=function(e){if(!this.has(e))throw new Error('OrderScript runtime error: variable "'+e+'" is not defined');return this.table[e]},s.prototype.store=function(e,t){this.has(e)||this.names.push(e),this.table[e]=t},s.prototype["delete"]=function(e){var t=this.names.indexOf(e);-1!==t&&(delete this.table[e],this.names.splice(t,1))},s.prototype.variables=function(){return this.names.map(function(e){return this.table[e]}.bind(this))};var u=function(e){this.sourceVariableName=e.sourceVariableName,this.sourceMemberName=e.sourceMemberName,this.targetVariableName=e.targetVariableName,this.targetMemberName=e.targetMemberName},c=n.inherits(function(){c.super_.call(this)},n.List);c.prototype.equal=function(e,t){return e.sourceVariableName===t.sourceVariableName&&e.sourceMemberName===t.sourceMemberName&&e.targetVariableName===t.targetVariableName&&e.targetMemberName===t.targetMemberName},c.prototype.removeVariable=function(e){for(var t=this.data,r=t.length-1;r>=0;r--){var n=t[r];(n.sourceVariableName===e||n.targetVariableName===e)&&t.splice(r,1)}};var p=function(e){this.circuitElementFactory=e.circuitElementFactory,this.circuitElementDisposal=e.circuitElementDisposal,this.scriptLoader=e.scriptLoader,this.scriptSaver=e.scriptSaver,this.variableTable=new s,this.bindingList=new c};p.prototype.exec=function(e){return Promise.resolve().then(function(){var t=i.parseStatement(i.expandAbbreviation(e));return this["exec"+n.capitalize(t.name)](t)}.bind(this))},p.prototype.execNoop=function(e){return e},p.prototype.execNew=function(e){var t=e.variableName;if(this.variableTable.has(t))throw new Error('OrderScript runtime error: variable "'+t+'" is already defined');var r=e.moduleName;return Promise.resolve().then(function(){return this.circuitElementFactory({variableName:t,moduleName:r})}.bind(this)).then(function(n){if(!n)throw new Error("OrderScript runtime error: Invalid circuit element");return this.variableTable.store(t,new a({name:t,moduleName:r,circuitElement:n})),e}.bind(this))},p.prototype.execBind=function(e){var t=this.bindingList,r=new u(e);if(t.contains(r))throw new Error("OrderScript runtime error: Already bound");var n=this.variableTable,i=n.fetch(e.sourceVariableName),a=n.fetch(e.targetVariableName),s=i.fetchMember(e.sourceMemberName),c=a.fetchMember(e.targetMemberName);return o.bind(s,c),t.add(r),e},p.prototype.execUnbind=function(e){var t=this.bindingList,r=new u(e);if(!t.contains(r))throw new Error("OrderScript runtime error: Not bound");var n=this.variableTable,i=n.fetch(e.sourceVariableName),a=n.fetch(e.targetVariableName),s=i.fetchMember(e.sourceMemberName),c=a.fetchMember(e.targetMemberName);return o.unbind(s,c),t.remove(r),e},p.prototype.execSend=function(e){var t=this.variableTable.fetch(e.variableName),r=t.fetchMember(e.memberName);return r(e.dataText),e},p.prototype.execDelete=function(e){var t=e.variableName,r=this.variableTable.fetch(t);return Promise.resolve().then(function(){return this.circuitElementDisposal({variableName:t})}.bind(this)).then(function(){return r.members().forEach(o.unbindAll),this.bindingList.removeVariable(t),this.variableTable["delete"](t),e}.bind(this))},p.prototype.execReset=function(e){return Promise.all(this.variableTable.names.map(function(e){return Promise.resolve().then(function(){return this.circuitElementDisposal({variableName:e})}.bind(this)).then(function(){var t=this.variableTable,r=t.fetch(e);r.members().forEach(o.unbindAll),this.bindingList.removeVariable(e),t["delete"](e)}.bind(this))}.bind(this))).then(function(){return e})},p.prototype.execLoad=function(e){var t=e.filePath;return Promise.resolve().then(function(){return this.scriptLoader(t)}.bind(this)).then(function(e){return new Promise(function(r,n){var i=e.split(/\r\n|\r|\n/g),o=function(e){return e>=i.length?void r():void this.exec(i[e]).then(function(){o(e+1)})["catch"](function(r){var i=t.split("/").pop(),o=e+1,a=i+":"+o+": "+r.message;n(new SyntaxError(a,i,o))})}.bind(this);o(0)}.bind(this))}.bind(this)).then(function(){return e})},p.prototype.execSave=function(e){var t=e.filePath;return Promise.resolve().then(function(){var e=this.variableTable.variables(),r=this.bindingList.toArray(),n=e.map(function(e){return e.name+":"+e.moduleName}).join("\n"),i=r.map(function(e){return e.sourceVariableName+"."+e.sourceMemberName+" >> "+e.targetVariableName+"."+e.targetMemberName}).join("\n"),o=[n,i].filter(function(e){return e}).join("\n")+"\n";return this.scriptSaver(t,o)}.bind(this)).then(function(){return e})},"undefined"!=typeof t&&t.exports?t.exports=p:r.Environment=p}(this.app||(this.app={}))},{"../helper.js":6,"./circuit-element.js":7,"./command.js":8}],10:[function(e,t,r){(function(r){!function(n){"use strict";var i=n.helper||e("./helper.js"),o=n.dom||e("./dom.js"),a=n.Environment||e("./models/environment.js"),s=n.CommandInput||e("./components/command-input.js"),u=n.ContentComponent||e("./components/content-component.js"),c=function(){i.bindAll(this),this.env=new a({circuitElementFactory:this.circuitElementFactory,circuitElementDisposal:this.circuitElementDisposal,scriptLoader:this.scriptLoader,scriptSaver:this.scriptSaver}),this.commandInput=new s({element:o.el(".command-input"),executor:this.executor}),this.contentComponent=new u({element:o.el(".content")})};c.prototype.circuitElementFactory=function(e){return this.contentComponent.loadVariable(e.variableName,e.moduleName).then(function(e){return e.circuitElement()})},c.prototype.circuitElementDisposal=function(e){this.contentComponent.deleteVariable(e.variableName)},c.prototype.scriptLoader=function(e){if(!e)throw new Error("OrderScript runtime error: Invalid script file path");return o.ajax({type:"GET",url:"order_scripts/"+e})},c.prototype.scriptSaver=function(e,t){return o.openWindow(e,"<pre>"+t+"</pre>")["catch"](function(){throw new Error("OrderScript runtime error: Failed to save script")})},c.prototype.executor=function(e){return this.env.exec(e)},n.main=new c,"undefined"!=typeof t&&t.exports&&(n.CircuitElement=e("./models/circuit-element.js"),r.app=n)}(this.app||(this.app={}))}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./components/command-input.js":1,"./components/content-component.js":3,"./dom.js":5,"./helper.js":6,"./models/circuit-element.js":7,"./models/environment.js":9}]},{},[10]);