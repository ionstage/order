var app=app||{};!function(){"use strict";function e(e,t){for(var r=0,n=t.length;n>r;r+=1){var a=t[r],o=m[a].parse(e);if(o)return o.type=a,o}}function t(e){return":"===e.charAt(0)}function r(e,t,r){var n=v(v("#module-template").html());return n.children(".header").children(".variable-name").text(e),n.children(".header").children(".class-name").text(t),n.find(".component").attr("src",r),n}function n(e,t){var n="coco_modules/"+t.replace(/\./g,"/")+".html",o=n+"?"+(new Date).getTime()+"#"+e,p=r(e,t,o),l={name:e,className:t,src:n,$el:p,loaded:!1,onload:a,onprop:i,onevent:c};return l}function a(e){var t=e.data;this.loaded=!0,this.data=t;var r=this.$el;r.children(".loading").hide(),r.find(".component").height(t.componentHeight),"0px"===t.componentHeight&&(r.find(".component").hide(),r.css("border-bottom","0")),this.cel=u.create(o(this.variables,this.name,t))}function o(e,t,r){var n={prop:{},event:{}},a=r.prop||{};for(var o in a)n.prop[o]={},"in"in a[o]&&(n.prop[o]["in"]=function(t,r){return function(){var n=Array.prototype.slice.call(arguments);e[t].data.prop[r].data=n;var a={type:"prop",target:r,data:n};e[t].$el.find(".component").get(0).contentWindow.postMessage(JSON.stringify(a),"*")}}(t,o)),"out"in a[o]&&(n.prop[o].out=function(t,r){return function(n){return e[t].data.prop[r].data}}(t,o));var i=r.event||{};for(var o in i)n.event[o]={},"in"in i[o]&&(n.event[o]["in"]=function(t,r){return function(){var n={type:"event",target:r,isConnected:!0};e[t].$el.find(".component").get(0).contentWindow.postMessage(JSON.stringify(n),"*")}}(t,o)),"out"in i[o]&&(n.event[o].out=u.noop);return n}function i(e){this.data.prop[e.target].data=e.data,this.cel.updateProperty(e.target)}function c(e){this.cel.dispatchEvent(e.target)}function p(e,t){var r=v.Deferred(),n=t.$el;return n.find(".component").load(function(){setTimeout(function(){if(t.loaded)r.resolve();else{var n=t.$el;n.remove(),delete t.variables[e],r.reject()}},d?1e3/60:0)}),v("#module-list .container").append(n),r.promise()}function l(e,t,r){var n="prop"===e?" => ":" -> ";return t.name+"."+t.target+n+r.name+"."+r.target}function s(e,t,r){var n=v(v("#connection-template").html());return n.text(l(e,t,r)),n}var u=require("circuit"),v=require("jquery"),f=navigator.userAgent,d=f.match(/MSIE/)||f.match(/Trident/);app.variables={};var m={empty:{parse:function(e){return""===e?{}:void 0},exec:function(e,t){return v.Deferred().resolve().promise()}},comment:{parse:function(e){return"#"===e.charAt(0)?{}:void 0},exec:function(e,t){return v.Deferred().resolve().promise()}},declare:{parse:function(e){var t=e.match(/^([^:]+):([^:]+)$/);if(t&&3===t.length)return{variableName:t[1],className:t[2]}},exec:function(e,t){var r=e.variableName;if(r in t)return v.Deferred().reject().promise();var a=n(r,e.className);return t[r]=a,a.variables=t,p(r,a)}},connect:{parse:function(e){var t=e.match(/^([^:]+?)[\s]*([=|-])>[\s]*([^:]+)$/);if(t&&4===t.length){var r=t[1].split("."),n=t[3].split(".");if(2===r.length&&2===n.length)return{connectType:"="===t[2]?"prop":"event",source:{name:r[0],target:r[1]},target:{name:n[0],target:n[1]}}}},exec:function(e,t){var r=v.Deferred(),n=e.source,a=e.target,o=t[n.name],i=t[a.name];if(!o||!i)return r.reject(),r.promise();var c=e.connectType,p=o.cel[c][n.target],l=i.cel[c][a.target];if(u.connect(p,l)){var f=s(c,n,a);v("#connection-list .container").append(f),r.resolve()}else r.reject();return r.promise()}},load:{parse:function(e){var t=e.match(/^:load[\s]*(.*)$/);if(t&&2===t.length)return{src:t[1]}},exec:function(e,t){var r=v.Deferred();return v.ajax({url:"coco_scripts/"+e.src,dataType:"text",cache:!1}).done(function(e){var n=e.split("\n");!function a(e){var o=n[e];app.execCommand(o,t).done(function(){e+=1,e<n.length?a(e):r.resolve()}).fail(function(){alert("error: L"+(e+1)+", "+o),r.reject()})}(0)}).fail(function(){r.reject()}),r.promise()}},update:{parse:function(e){var t=e.match(/^(.+)[\s]*=>[\s]*([^:]+)$/);if(t&&3===t.length){var r=v.trim(t[1]),n=r.match(/^"(.*)"$/);if(n)r=n[1];else try{r=JSON.parse(r)}catch(a){return}var o=t[2].split(".");if(2===o.length)return{value:r,target:{name:o[0],target:o[1]}}}},exec:function(e,t){var r=v.Deferred(),n=app.variables[e.target.name];if(!n)return r.reject(),r.promise();var a=e.value,o=n.cel.prop[e.target.target]["in"];return"function"==typeof o?(o(a),r.resolve()):r.reject(),r.promise()}},dispatch:{parse:function(e){var t=e.match(/^->[\s]*([^:]+)$/);if(t&&2===t.length){var r=t[1].split(".");if(2===r.length)return{target:{name:r[0],target:r[1]}}}},exec:function(e,t){var r=v.Deferred(),n=t[e.target.name];if(!n)return r.reject(),r.promise();var a=n.cel.event[e.target.target]["in"];return"function"==typeof a?(a(),r.resolve()):r.reject(),r.promise()}},disconnect:{parse:function(e){var t=e.match(/^([^:]+?)[\s]*([=|-])\/>[\s]*([^:]+)$/);if(t&&4===t.length){var r=t[1].split("."),n=t[3].split(".");if(2===r.length&&2===n.length)return{connectType:"="===t[2]?"prop":"event",source:{name:r[0],target:r[1]},target:{name:n[0],target:n[1]}}}},exec:function(e,t){var r=v.Deferred(),n=e.source,a=e.target,o=t[n.name],i=t[a.name];if(!o||!i)return r.reject(),r.promise();var c=e.connectType,p=o.cel[c][n.target],s=i.cel[c][a.target];return u.disconnect(p,s)?(v("#connection-list .container").children().each(function(e,t){var r=v(t);r.text()===l(c,n,a)&&r.remove()}),r.resolve()):r.reject(),r.promise()}},"delete":{parse:function(e){var t=e.match(/^\/\/[\s]*([^:]+)$/);if(t&&2===t.length)return{variableName:t[1]}},exec:function(e,t){var r=v.Deferred(),n=e.variableName;if(!(n in t))return r.reject(),r.promise();var a=t[n];return a.$el.remove(),v("#connection-list .container").children().each(function(e,r){var a=v(r),o=a.text(),i=o.match(/^([^:]+?)[\s]*([=|-])>[\s]*([^:]+)$/);if(i&&4===i.length){var c=i[1].split("."),p=i[3].split(".");if(c[0]===n||p[0]===n){var l=t[c[0]],s=t[p[0]],f="="===i[2]?"prop":"event",d=l.cel[f][c[1]],m=s.cel[f][p[1]];u.disconnect(d,m),a.remove()}}}),delete t[n],r.resolve(),r.promise()}},clear:{parse:function(e){var t=e.match(/^:clear$/);return t?{}:void 0},exec:function(e,t){var r=v.Deferred();for(var n in t){var a=t[n];a.$el.remove(),delete t[n]}return v("#module-list .container").empty(),v("#connection-list .container").empty(),r.resolve(),r.promise()}},save:{parse:function(e){var t=e.match(/^:save$/);return t?{}:void 0},exec:function(e,t){var r=v.Deferred(),n="";for(var a in t){var o=t[a];n+=a+":"+o.className+"\n"}if(v("#connection-list .container").children().each(function(e,t){var r=v(t);n+=r.text()+"\n"}),""!==n){var i="data:application/octet-stream,"+encodeURIComponent(n),c=window.open(d?"about:blank":i,"");c&&c.document&&(c.document.open(),c.document.write("<pre>"+n+"</pre>"),c.document.close())}return r.resolve(),r.promise()}}};app.parseCommand=function(r){if("undefined"==typeof r||null===r)return null;r=v.trim(r);var n=e(r,["empty","comment"])||(t(r)?e(r,["load","clear","save"]):e(r,["update","declare","connect","dispatch","disconnect","delete"]))||null;return n},app.execCommand=function(e,t){var r=v.Deferred(),n=app.parseCommand(e);if(null===n)return r.reject(),r.promise();var a=m[n.type].exec;return"function"==typeof a&&a(n,t).done(r.resolve).fail(r.reject),r.promise()},v(window).bind("message",function(e){var t=JSON.parse(e.originalEvent.data),r=app.variables[t.id];if(r){var n=r["on"+t.type];"function"==typeof n&&n.call(r,t)}}),app.execCommand(":load init.coco",app.variables);var h=v("#header input"),g=function(){var e=[],t=0;return function(r){switch(r.which){case 13:r.preventDefault(),h.prop("disabled",!0);var n=r.target.value;app.execCommand(r.target.value,app.variables).done(function(){e.push(n),t=e.length,h.val("")}).always(function(){h.prop("disabled",!1),h.blur(),setTimeout(function(){h.focus()},0)});break;case 38:r.preventDefault(),t=Math.max(t-1,0),h.val(e[t]||e[0]);break;case 40:r.preventDefault(),t=Math.min(t+1,e.length),h.val(e[t]||"")}}}();h.bind("keydown",g),setTimeout(function(){h.val(""),h.focus()},0)}();