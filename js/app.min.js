!function o(s,u,a){function c(e,t){if(!u[e]){if(!s[e]){var n="function"==typeof require&&require;if(!t&&n)return n(e,!0);if(d)return d(e,!0);var i=new Error("Cannot find module '"+e+"'");throw i.code="MODULE_NOT_FOUND",i}var r=u[e]={exports:{}};s[e][0].call(r.exports,function(t){return c(s[e][1][t]||t)},r,r.exports,o,s,u,a)}return u[e].exports}for(var d="function"==typeof require&&require,t=0;t<a.length;t++)c(a[t]);return c}({1:[function(r,t,e){!function(t){"use strict";var e=t.dom||r("./dom.js"),n=t.CircuitModule||r("./models/circuit-module.js"),i=t.Main||r("./components/main.js");e.export("OrderModule",n.OrderModule),t.main=new i({element:e.body()})}(this.app||(this.app={}))},{"./components/main.js":5,"./dom.js":7,"./models/circuit-module.js":9}],2:[function(s,u,t){!function(t){"use strict";var n,e,i=s("jcore"),r=t.dom||s("../dom.js"),o=i.Component.inherits(function(){this.history=new o.History({size:100,key:"order/input-history"})});o.prototype.text=function(t){return r.value(this.element(),t)},o.prototype.disabled=function(t){r.disabled(this.element(),t)},o.prototype.isError=function(t){r.toggleClass(this.element(),"error",t)},o.prototype.focus=function(){r.focus(this.element())},o.prototype.blur=function(){r.blur(this.element())},o.prototype.done=function(t){t?(this.isError(!0),r.once(this.element(),"input",this.oninput.bind(this))):(this.history.push(this.text()),this.history.save(),this.text("")),this.disabled(!1),this.focus()},o.prototype.oninit=function(){this.history.load(),this.focus(),r.on(this.element(),"keydown",this.onkeydown.bind(this))},o.prototype.onkeydown=(n={13:"enter",38:"up",40:"down"},function(t){var e=n[t.which];e&&(this.isError(!1),this["on"+e](t))}),o.prototype.onenter=function(){var t=this.text();t&&(this.disabled(!0),this.emit("exec",t,this.done.bind(this)))},o.prototype.onup=function(t){r.cancel(t),this.text(this.history.back())},o.prototype.ondown=function(t){r.cancel(t),this.text(this.history.forward())},o.prototype.oninput=function(){this.isError(!1)},o.History=((e=function(t){this.data=[],this.index=0,this.size=t.size,this.key=t.key}).prototype.current=function(){return this.data[this.index]||""},e.prototype.push=function(t){this.data.push(t),this.data.splice(0,this.data.length-this.size),this.index=this.data.length},e.prototype.back=function(){return this.index=Math.max(this.index-1,0),this.current()},e.prototype.forward=function(){return this.index=Math.min(this.index+1,this.data.length),this.current()},e.prototype.load=function(){this.data=r.load(this.key,[]),this.index=this.data.length},e.prototype.save=function(){r.save(this.key,this.data)},e),void 0!==u&&u.exports?u.exports=o:t.CommandInput=o}(this.app||(this.app={}))},{"../dom.js":7,jcore:void 0}],3:[function(r,o,t){!function(t){"use strict";var e=r("jcore"),i=t.Variable||r("./variable.js"),n=e.Component.inherits(function(){this.variableTable={}});n.prototype.loadVariable=function(t,e){var n=new i({name:t,moduleName:e});return n.parentElement(this.element()),n.redraw(),n.load().then(function(){return this.variableTable[t]=n}.bind(this)).catch(function(t){throw n.parentElement(null),t})},n.prototype.deleteVariable=function(t){this.variableTable[t].parentElement(null),delete this.variableTable[t]},void 0!==o&&o.exports?o.exports=n:t.Content=n}(this.app||(this.app={}))},{"./variable.js":6,jcore:void 0}],4:[function(r,o,t){!function(t){"use strict";var e=r("jcore"),n=t.dom||r("../dom.js"),i=e.Component.inherits();i.prototype.load=function(){return new Promise(function(e){var t=function(t){e(n.file(n.target(t)))};n.on(this.element(),"change",t),n.click(this.element()),n.once(n.body(),"focus",function(){n.off(this.element(),"change",t)}.bind(this),!0)}.bind(this)).then(function(t){var e=n.fileName(t);return n.value(this.element(),""),n.readFile(t).then(function(t){return{text:t,fileName:e}})}.bind(this))},void 0!==o&&o.exports?o.exports=i:t.FileInput=i}(this.app||(this.app={}))},{"../dom.js":7,jcore:void 0}],5:[function(c,d,t){!function(t){"use strict";var i=c("file-saver"),e=c("jcore"),n=t.dom||c("../dom.js"),r=t.CommandInput||c("./command-input.js"),o=t.Content||c("./content.js"),s=t.Environment||c("../models/environment.js"),u=t.FileInput||c("./file-input.js"),a=e.Component.inherits(function(){this.env=new s({circuitModuleLoader:this.circuitModuleLoader.bind(this),circuitModuleUnloader:this.circuitModuleUnloader.bind(this),scriptLoader:this.scriptLoader.bind(this),scriptSaver:this.scriptSaver.bind(this)}),this.commandInput=new r({element:this.findElement(".command-input")}),this.fileInput=new u({element:this.findElement(".file-input")}),this.content=new o({element:this.findElement(".content")})});a.prototype.circuitModuleLoader=function(t,e){return this.content.loadVariable(t,e).then(function(t){return t.circuitModule()})},a.prototype.circuitModuleUnloader=function(e){return new Promise(function(t){this.content.deleteVariable(e),t()}.bind(this))},a.prototype.scriptLoader=function(e){return e?n.ajax({type:"GET",url:"order_scripts/"+e}).then(function(t){return{text:t,fileName:e.split("/").pop()}}):(this.commandInput.disabled(!1),this.commandInput.blur(),this.fileInput.load())},a.prototype.scriptSaver=function(e,n){return new Promise(function(t){i.saveAs(new Blob([n],{type:"plain/text"}),e),t()})},a.prototype.oninit=function(){this.commandInput.on("exec",this.onexec.bind(this))},a.prototype.onexec=function(t,e){this.env.exec(t).then(function(){e()}).catch(function(t){console.error(t),e(t)})},void 0!==d&&d.exports?d.exports=a:t.Main=a}(this.app||(this.app={}))},{"../dom.js":7,"../models/environment.js":11,"./command-input.js":2,"./content.js":3,"./file-input.js":4,"file-saver":void 0,jcore:void 0}],6:[function(o,s,t){!function(t){"use strict";var e,n=o("jcore"),r=t.dom||o("../dom.js"),i=n.Component.inherits(function(t){this.name=this.prop(t.name),this.moduleName=this.prop(t.moduleName),this.content=new i.Content({element:this.findElement(".variable-content")})});i.prototype.nameElement=function(){return this.findElement(".variable-name")},i.prototype.moduleNameElement=function(){return this.findElement(".variable-module-name")},i.prototype.contentUrl=function(){return"order_modules/"+encodeURI(this.moduleName())+".html"},i.prototype.circuitModule=function(){return this.content.circuitModule()},i.prototype.render=function(){return r.render(i.HTML_TEXT)},i.prototype.oninit=function(){r.text(this.nameElement(),this.name()),r.text(this.moduleNameElement(),this.moduleName())},i.prototype.load=function(){return this.content.load(this.contentUrl())},i.HTML_TEXT=['<div class="variable">','<div class="variable-header">','<div class="variable-name"></div>','<div class="variable-module-name"></div>',"</div>",'<iframe class="variable-content"></iframe>',"</div>"].join(""),i.Content=((e=n.Component.inherits()).prototype.contentWindow=function(){return r.contentWindow(this.element())},e.prototype.circuitModule=function(){var t=this.contentWindow().order;return t&&t.exports},e.prototype.load=function(i){return new Promise(function(t,e){var n=setTimeout(e,3e4,new Error("OrderScript runtime error: Load timeout for content"));r.once(this.element(),"load",function(){clearTimeout(n),t(this.circuitModule())}.bind(this)),r.attr(this.element(),{src:i})}.bind(this)).then(function(t){if(!t)throw new Error("OrderScript runtime error: Invalid circuit module");r.css(this.element(),{height:r.contentHeight(this.element())+"px"})}.bind(this))},e),void 0!==s&&s.exports?s.exports=i:t.Variable=i}(this.app||(this.app={}))},{"../dom.js":7,jcore:void 0}],7:[function(t,e,n){(function(i){!function(t){"use strict";var o={export:function(t,e){var n=void 0!==i?i:window;Object.defineProperty(n,t,{value:e})},body:function(){return document.body},render:function(t){var e=document.createRange().createContextualFragment(t).firstChild;return e.parentNode.removeChild(e),e},attr:function(e,n){Object.keys(n).forEach(function(t){e.setAttribute(t,n[t])})},css:function(t,e){var n=t.style;Object.keys(e).forEach(function(t){n[t]=e[t]})},toggleClass:function(t,e,n){n?t.classList.add(e):t.classList.remove(e)},text:function(t,e){t.textContent=e},value:function(t,e){if(void 0===e)return t.value;t.value=e},disabled:function(t,e){t.disabled=e},focus:function(t){t.focus()},blur:function(t){t.blur()},file:function(t){return t.files[0]},contentWindow:function(t){return t.contentWindow},contentHeight:function(t){return t.contentDocument.documentElement.scrollHeight},on:function(t,e,n,i){t.addEventListener(e,n,!!i)},off:function(t,e,n,i){t.removeEventListener(e,n,!!i)},once:function(t,e,n,i){var r=function(){o.off(t,e,r,i),n.apply(null,arguments)};o.on(t,e,r,i)},click:function(t){t.click()},target:function(t){return t.target},cancel:function(t){t.preventDefault()},readFile:function(r){return new Promise(function(e,t){var n=new FileReader,i=function(){t(new Error("Failed to read file: "+r.name))};n.onload=function(t){e(t.target.result)},n.onerror=i,n.onabort=i,n.readAsText(r)})},fileName:function(t){return t.name},ajax:function(t){var r=t.type,o=t.url;return new Promise(function(t,e){var n=new XMLHttpRequest,i=function(){e(new Error("Failed to load resource: "+r+" "+o))};n.onload=function(){200<=n.status&&n.status<400?t(n.response):i()},n.onerror=i,n.onabort=i,n.open(r,o,!0),n.send()})},load:function(t,e){return JSON.parse(localStorage.getItem(t))||e},save:function(t,e){localStorage.setItem(t,JSON.stringify(e))}};void 0!==e&&e.exports?e.exports=o:t.dom=o}(this.app||(this.app={}))}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],8:[function(t,n,e){!function(t){"use strict";var e={values:function(e){return Object.keys(e).map(function(t){return e[t]})},remove:function(t,e){var n=t.indexOf(e);-1!==n&&t.splice(n,1)},find:function(t,e){for(var n=0,i=t.length;n<i;n++)if(e(t[n],n,t))return t[n];return null},wrapper:function(){var n=function(t,e){return Object.defineProperty(e,"unwrap",{value:n.unwrap.bind(t)})};return n.unwrap=function(t){return t===n.KEY?this:null},n.KEY={},n}};void 0!==n&&n.exports?n.exports=e:t.helper=e}(this.app||(this.app={}))},{}],9:[function(i,s,t){!function(t){"use strict";var e,r=i("circuit"),o=(t.helper||i("../helper.js")).wrapper(),n=function(t){this.memberTable=t};n.prototype.get=function(t){return this.memberTable[t]||null},n.bind=function(t,e){var n=t.unwrap(o.KEY).callee,i=e.unwrap(o.KEY).callee;r.bind(n,i)},n.unbind=function(t,e){var n=t.unwrap(o.KEY).callee,i=e.unwrap(o.KEY).callee;r.unbind(n,i)},n.Member=((e=function(t){return this.callee=r[t.type](t.arg),this.wrapper(t.name)}).prototype.call=function(){return this.callee.apply(this,arguments)},e.prototype.wrapper=function(t){var e=new o(this,this.call.bind(this));return Object.defineProperty(e,"name",{value:t})},e),n.OrderModule=function(t){return new n(t.reduce(function(t,e){return t[e.name]=new n.Member(e),t},{}))},void 0!==s&&s.exports?s.exports=n:t.CircuitModule=n}(this.app||(this.app={}))},{"../helper.js":8,circuit:void 0}],10:[function(t,n,e){!function(t){"use strict";var e={parse:function(t){var e,n,i,r=(e=t.match(/".*?[^\\]"|'.*?[^\\]'|\.|#|:|>>|<<|[\w"'\/\\]+/g)||[],-1!==(n=e.indexOf("#"))?e.slice(0,n):e),o=(":"===(i=r.slice())[0]&&2<=i.length?(i.shift(),i[0]=i[0].toLowerCase()):":"===i[1]?(i.splice(1,1),i.unshift("new")):"."===i[1]&&">>"===i[3]&&"."===i[5]?(i.splice(3,1),i.unshift("bind")):"."===i[1]&&"<<"===i[3]&&(i.splice(3,1),i.unshift("send")),i);if(!function(t){switch(t[0]){case"new":return 3===t.length&&/^[a-zA-Z]/.test(t[1])&&/^[a-zA-Z]/.test(t[2]);case"bind":case"unbind":return 7===t.length&&"."===t[2]&&"."===t[5];case"send":return 4<=t.length&&t.length<=5&&"."===t[2];case"delete":return 2===t.length&&/^[a-zA-Z]/.test(t[1]);case"reset":return 1===t.length;case"load":case"save":return t.length<=2;default:return 0===t.length}}(o))throw new SyntaxError('OrderScript parse error: Unexpected identifier "'+t+'"');return o.filter(function(t){return"."!==t}).map(function(t){var e=t.charAt(0);return e!==t.slice(-1)||"'"!==e&&'"'!==e||(t=t.slice(1,-1)),t.replace(/\\(["'])/g,"$1")})}};void 0!==n&&n.exports?n.exports=e:t.Command=e}(this.app||(this.app={}))},{}],11:[function(e,n,t){!function(t){"use strict";var i=t.helper||e("../helper.js"),r=t.Command||e("./command.js"),o=t.CircuitModule||e("./circuit-module.js"),s=function(t){this.circuitModuleLoader=t.circuitModuleLoader,this.circuitModuleUnloader=t.circuitModuleUnloader,this.scriptLoader=t.scriptLoader,this.scriptSaver=t.scriptSaver,this.variableTable={},this.bindings=[]};s.prototype.findVariable=function(e){return i.find(i.values(this.variableTable),function(t){return t.circuitModule.get(e.name)===e})},s.prototype.findBinding=function(e,n){return i.find(this.bindings,function(t){return t.sourceMember===e&&t.targetMember===n})},s.prototype.fetchMember=function(t,e){if(!this.variableTable.hasOwnProperty(t))throw new Error('OrderScript runtime error: variable "'+t+'" is not defined');var n=this.variableTable[t].circuitModule.get(e);if(!n)throw new Error('OrderScript runtime error: member "'+t+"."+e+'" is not defined');return n},s.prototype.loadVariable=function(e,n){return this.circuitModuleLoader(e,n).then(function(t){if(!t)throw new Error("OrderScript runtime error: Invalid circuit module");this.variableTable[e]=new s.Variable({name:e,moduleName:n,circuitModule:t})}.bind(this))},s.prototype.unloadVariable=function(t){return this.circuitModuleUnloader(t).then(function(){this.deleteVariable(t)}.bind(this))},s.prototype.deleteVariable=function(t){var e=this.variableTable[t];this.bindings.filter(function(t){return this.findVariable(t.sourceMember)===e||this.findVariable(t.targetMember)===e}.bind(this)).forEach(function(t){o.unbind(t.sourceMember,t.targetMember),i.remove(this.bindings,t)}.bind(this)),delete this.variableTable[t]},s.prototype.bind=function(t,e){if(this.findBinding(t,e))throw new Error("OrderScript runtime error: Already bound");o.bind(t,e),this.bindings.push(new s.Binding({sourceMember:t,targetMember:e}))},s.prototype.unbind=function(t,e){var n=this.findBinding(t,e);if(!n)throw new Error("OrderScript runtime error: Not bound");o.unbind(t,e),i.remove(this.bindings,n)},s.prototype.loadScript=function(t,i){return t.split(/\r\n|\r|\n/g).reduce(function(t,e,n){return t.then(function(){return this.exec(e).catch(function(t){throw new SyntaxError(t.message,i,n+1)})}.bind(this))}.bind(this),Promise.resolve())},s.prototype.generateScript=function(){return(i.values(this.variableTable).map(function(t){return t.name+":"+t.moduleName}).join("\n")+"\n"+this.bindings.map(function(t){return this.findVariable(t.sourceMember).name+"."+t.sourceMember.name+" >> "+this.findVariable(t.targetMember).name+"."+t.targetMember.name}.bind(this)).join("\n")).trim()+"\n"},s.prototype.exec=function(t){return"string"==typeof t&&(t=[t]),t.reduce(function(t,n){return t.then(function(){var t=r.parse(n);if(0!==t.length){var e=t.shift();return s.EXEC_TABLE[e].apply(this,t)}}.bind(this))}.bind(this),Promise.resolve())},s.EXEC_TABLE={new:function(t,e){if(this.variableTable.hasOwnProperty(t))throw new Error('OrderScript runtime error: variable "'+t+'" is already defined');return this.loadVariable(t,e)},bind:function(t,e,n,i){var r=this.fetchMember(t,e),o=this.fetchMember(n,i);this.bind(r,o)},unbind:function(t,e,n,i){var r=this.fetchMember(t,e),o=this.fetchMember(n,i);this.unbind(r,o)},send:function(t,e,n){this.fetchMember(t,e)(n)},delete:function(t){if(!this.variableTable.hasOwnProperty(t))throw new Error('OrderScript runtime error: variable "'+t+'" is not defined');return this.unloadVariable(t)},reset:function(){return Promise.all(Object.keys(this.variableTable).map(function(t){return this.unloadVariable(t)}.bind(this)))},load:function(t){return this.scriptLoader(t).then(function(t){return this.loadScript(t.text,t.fileName)}.bind(this))},save:function(t){return this.scriptSaver(t,this.generateScript())}},s.Variable=function(t){this.name=t.name,this.moduleName=t.moduleName,this.circuitModule=t.circuitModule},s.Binding=function(t){this.sourceMember=t.sourceMember,this.targetMember=t.targetMember},void 0!==n&&n.exports?n.exports=s:t.Environment=s}(this.app||(this.app={}))},{"../helper.js":8,"./circuit-module.js":9,"./command.js":10}]},{},[1]);